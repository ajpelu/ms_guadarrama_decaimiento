---
title: "Temporal analysis of IV"
format: 
  html:
    toc: true
execute: 
  warning: false
  error: false
editor_options: 
  chunk_output_type: console
---

## Aims
- To explore the temporal evolution of several spectral indices for forest stands with tree mortality comparing with control forest stands. 
- Two species: *Pinus sylvestris* and *P. pinaster* 
- Two sites; Valdemaqueda (pinaster) and Valsa√≠n (sylvestris)
- Spectral product used: 

  - Landsat: several collections. We used the harmonized product. Spatial resolution = 30 m; temporal range: 1985-2023; temporal resolution = varies according to product used. [More info](https://landsat.gsfc.nasa.gov/satellites/landsat-8/). 
  - Sentinel2: spatial resolution = 10-20 m; temporal range: 2017-2023; temporal resolution = 25 days
  - MODIS MOD13Q1: spatial resolution = 250 m; temporal range: 2000-2023; temporal resolution = 23 days
  
## Prepare Data 
- All the data were obtained using GEE
- We applied several filters to remove low quality data (avoid clouds, etc) 

```{r}
library(tidyverse)
library(Kendall)
library(trend)
library(kableExtra)
options(tidyverse.quiet = TRUE)
```

```{r}
raw_landsat <- read_csv("data/raw/guadarrama_pinaster_syl_landsat_c02.csv")
raw_modis <- read_csv("data/raw/guadarrama_pinaster_syl_modis_mod13q1.csv")
pixel_id <- read_csv("data/geoinfo/pixel_idtree.csv")
```


## Landsat 
```{r}
raw_landsat <- read_csv("data/raw/guadarrama_pinaster_syl_landsat_c02.csv") |> 
  rename(evi = EVI, ndvi = NDVI) |>
  mutate(date = as.Date(as.character(date), format="%Y%m%d")) |> 
  mutate(date = as.Date(date, format = "%Y%m%d")) |> 
  dplyr::select(evi, ndvi, date, sp, status, name) |> 
  mutate(year = lubridate::year(date), 
         month = lubridate::month(date)) |> 
  dplyr::filter(!(name %in% c("S01", "S02", "S03", "S04", "S05", "S06")))

```

### EVI 
```{r}

landsat_evi <- raw_landsat |> 
  dplyr::select(-ndvi) |> 
  filter(!is.na(evi)) |> 
  rename(value=evi) |> 
  mutate(iv="evi")

landsat_evi_id <- landsat_evi |> inner_join(pixel_id) |> 
  dplyr::select(-pixel_sentinel, -pixel_modis) 
  
landsat_evi_yearly <- landsat_evi_id |> 
  group_by(sp, status, year) |> 
    summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            n = length(value))
```

```{r}
#| fig-width: 10
colores_status <-  c("Decaimiento" = "red", 
                     "Sanos" ="blue")


landsat_evi_yearly |> 
  ggplot(aes(x = year, y = mean, fill=status, colour=status)) +
  geom_line() +  
  geom_ribbon(data=landsat_evi_yearly, 
              aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) +
  theme_bw() +
  facet_wrap(~sp, ncol = 1) + 
  scale_x_continuous(limits = c(1986, 2023), breaks = seq(1986,2023, by=4)) +
  theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) + 
  ylab("Annual EVI (Landsat)") +
  scale_fill_manual(values = colores_status)
```

- Temporal trend 

```{r}
#| echo: false
mk_evi_landsat <- landsat_evi_yearly |> 
  ungroup() |> 
  group_by(sp, status) |> 
  summarise(across(mean, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(mean, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(mean, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(mean, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen")) 



mk_evi_landsat |> 
  kbl(
    digits = c(0,0,3,5,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for yearly EVI (Landsat)") |> 
  column_spec(3:4, bold = ifelse(mk_evi_landsat$mean_pvalue_mk < 0.05, TRUE, FALSE)) |>
  column_spec(1, italic = TRUE) |> 
  collapse_rows(columns = 1:2) |> 
  kable_paper("hover", full_width = F)
```



### NDVI
```{r}

landsat_ndvi <- raw_landsat |> 
  dplyr::select(-evi) |> 
  filter(!is.na(ndvi)) |> 
  rename(value=ndvi) |> 
  mutate(iv="ndvi")

landsat_ndvi_id <- landsat_ndvi |> inner_join(pixel_id) |>
    dplyr::select(-pixel_sentinel, -pixel_modis) 

landsat_ndvi_yearly <- landsat_ndvi_id |> 
  group_by(sp, status, year) |> 
    summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            n = length(value))
```

```{r}
#| fig-width: 10
landsat_ndvi_yearly |> 
  ggplot(aes(x = year, y = mean, fill=status, colour=status)) +
  geom_line() +  
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) +
  theme_bw() +
  facet_wrap(~sp, ncol = 1) + 
  scale_x_continuous(limits = c(1986, 2023), breaks = seq(1986,2023, by=4)) +
  theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) + 
  ylab("Annual NDVI (Landsat)") +
  scale_fill_manual(values = colores_status)
```

- Temporal trend 

```{r}
#| echo: false
mk_ndvi_landsat <- landsat_ndvi_yearly |> 
  ungroup() |> 
  group_by(sp, status) |> 
  summarise(across(mean, ~MannKendall(.)$tau, .names ="{.col}_tau"),
            across(mean, ~MannKendall(.)$sl, .names ="{.col}_pvalue_mk"),
            across(mean, ~trend::sens.slope(.)$estimate, .names ="{.col}_senslope"),
            across(mean, ~trend::sens.slope(.)$p.value, .names ="{.col}_pvalue_sen")) 


mk_ndvi_landsat |> 
  kbl(
    digits = c(0,0,3,5,5,4),
    caption = "Mann-Kendall and Seil temporal trend test for yearly NDVI (Landsat)") |> 
  column_spec(3:4, bold = ifelse(mk_ndvi_landsat$mean_pvalue_mk < 0.05, TRUE, FALSE)) |>
  column_spec(1, italic = TRUE) |> 
  collapse_rows(columns = 1:2) |> 
  kable_paper("hover", full_width = F)
```



```{r}
#| eval: false
#| echo: false

#quitamos duplicados (mismo arbol en el mismo pixel) 
landsat_unique <- raw_landsat |> 
  dplyr::select(-name) |> 
  unique() |> 
  pivot_longer(evi:ndvi, names_to = "iv", values_to = "value")

yearly_landsat <- landsat_unique |> 
  group_by(sp, status, year, iv) |> 
  summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            n = length(value))
  

yearly_landsat |>
  filter(iv == "evi") |> 
  ggplot(aes(x = year, y = mean, fill=status, colour=status, group=status)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) + 
  geom_line() +
  geom_point() +
  theme_bw() +
    facet_wrap(~sp, nrow = 1) 

+
  ylab("Annual EVI (Landast 30-m)") +
  theme(
    strip.background = element_blank(),
    strip.text = element_text(hjust = 0, vjust = 1, margin = margin(-0.05, 0.8, 0, 0), 
                              face = "italic"),
    plot.background = element_rect(fill = "transparent"), 
    legend.position = "bottom"
  ) +
    scale_colour_manual(values = colours_elev, name = "") +
    scale_fill_manual(values = colours_elev, name="") + 
  facet_wrap(~factor(sp_code, levels = c("halepensis", "pinaster", "nigra", "sylvestris")), nrow = 1) +
  ggtitle("old")




```


### Sentinel 

- see [this paper](https://www.mdpi.com/2072-4292/14/9/2028) for some indexes used 

```{r}

raw_sentinel <- read_csv("data/raw/guadarrama_pinaster_syl_sentinel_harmonized.csv") |> 
  mutate(date = as.Date(as.character(substr(`system:index`, 1,8)), format="%Y%m%d")) |> 
  mutate(year = lubridate::year(date), 
         month = lubridate::month(date)) |> 
  dplyr::select(-`system:index`,-`.geo`, -ele, -numero, -tipo) |> 
  filter(!is.na(EVI)) |> 
  janitor::clean_names()
  

sentinel <- raw_sentinel |> 
  pivot_longer(evi:vig,  names_to = "iv", values_to = "value") |> 
  dplyr::filter(!(name %in% c("S01", "S02", "S03", "S04", "S05", "S06")))

sentinel_date <-
  sentinel |> 
  filter(date > as.Date("2017-06-01")) |> 
  mutate(date2 = as.Date(paste0(format(date, "%Y-%m"), "-01"), format = "%Y-%m-%d")) |> 
  group_by(sp, status, date2, iv) |> 
  summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            n = length(value)) |> 
  ungroup()
```

#### NDVI 
```{r}
#| fig-width: 10
sentinel_date |> 
  # filter(iv %in% c('savi','evi','ndvi','nbr')) |> 
  filter(iv == "ndvi") |> 
  filter(!(date2 == "2018-05-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  ggplot(aes(x = date2, y = mean, fill=status, colour=status, group = status)) +
  geom_line() +  
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) +
  theme_bw() +
  facet_wrap(~sp, ncol=1) + theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) + 
  ylab("NDVI (Sentinel)") +
  scale_fill_manual(values = colores_status) +
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m") +
  xlab("Date") +
  scale_y_continuous(breaks = c(0, 0.25,0.5,0.75))
```

#### EVI 

```{r}
#| fig-width: 10
sentinel_date |> 
  # filter(iv %in% c('savi','evi','ndvi','nbr')) |> 
  filter(iv == "evi") |> 
  filter(!(date2 == "2019-11-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  filter(!(date2 == "2018-05-01" & sp == "Pinus sylvestris" & status == "Decaimiento")) |> 
  ggplot(aes(x = date2, y = mean, fill=status, colour=status, group = status)) +
  geom_line() +  
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) +
  theme_bw() +
  facet_wrap(~sp, ncol=1) + theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) + 
  ylab("EVI (Sentinel)") +
  scale_fill_manual(values = colores_status) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m") +
  xlab("Date")
```


```{r}
#| fig-width: 10
#| eval: false
#| echo: false
sentinel_date |> 
  # filter(iv %in% c('savi','evi','ndvi','nbr')) |> 
  filter(iv == "savi") |> 
    filter(!(date2 == "2019-11-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  ggplot(aes(x = date2, y = mean, fill=status, colour=status, group = status)) +
  geom_line() +  
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) +
  theme_bw() +
  facet_wrap(~sp, ncol=1) + theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) + 
  ylab("Soil Adjusted Vegetation Index (Sentinel)") +
  scale_fill_manual(values = colores_status) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m") +
  xlab("Date")
```

#### NBR 

```{r}
#| fig-width: 10
sentinel_date |> 
  # filter(iv %in% c('savi','evi','ndvi','nbr')) |> 
  filter(iv == "nbr") |> 
  filter(!(date2 == "2018-05-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  ggplot(aes(x = date2, y = mean, fill=status, colour=status, group = status)) +
  geom_line() +  
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) +
  theme_bw() +
  facet_wrap(~sp, ncol=1) + theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) + 
  ylab("NBR (Sentinel)") +
  scale_fill_manual(values = colores_status) + 
  scale_x_date(date_breaks = "6 months", date_labels = "%Y-%m") +
  xlab("Date")
```


## MODIS 
```{r}
modis <- raw_modis |>
  mutate(date = as.Date(str_replace_all(substr(`system:index`, 1, 10), "_", "-"),
                        format = "%Y-%m-%d"),
         evi = EVI*0.0001,
         ndvi = NDVI*0.0001) |> 
    dplyr::filter(!(name %in% c("S01", "S02", "S03", "S04", "S05", "S06"))) |> 
  dplyr::select(sp, status, date, evi, ndvi) |> 
  unique()




df_modis <- modis |> 
  pivot_longer(evi:ndvi, 
               names_to = "iv", 
               values_to = "value")

df_modis_date <- df_modis |> 
  mutate(year = lubridate::year(date)) |> 
  group_by(sp, status, year, iv) |> 
  summarise(mean = mean(value, na.rm = TRUE), 
            sd = sd(value, na.rm = TRUE), 
            se = sd/sqrt(length(value)),
            cv = sd/mean*100,
            n = length(value))
```


```{r}
#| fig-width: 8
#| fig-height: 6
colores_status <-  c("Decaimiento" = "red", 
                     "Sanos" ="blue")


df_modis_date |> 
  filter(iv == "evi") |> 
  ggplot(aes(x=year, y=mean, fill=status, colour=status, group=status)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~sp, ncol = 1) +
  theme_bw() +
    theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) +
  ylab("Annual EVI (MODIS)") +
  scale_fill_manual(values = colores_status) +
  scale_colour_manual(values = colores_status)
```


```{r}


#| fig-width: 10
#| fig-height: 6

df_modis_date |> 
  filter(iv == "ndvi") |> 
  ggplot(aes(x=year, y=mean, fill=status, colour=status, group=status)) +
  geom_ribbon(aes(ymin = (mean - se), ymax=(mean+se)), colour=NA, alpha=.2) + 
  geom_point() + 
  geom_line() + 
  facet_wrap(~sp, ncol = 1) +
  theme_bw() +
    theme(
    panel.grid = element_blank(), 
    strip.text = element_text(face = "italic"),
    strip.background = element_rect(fill = "white"),
    legend.position = "bottom"
  ) +
  ylab("Annual NDVI (MODIS)") +
  scale_fill_manual(values = colores_status) +
  scale_colour_manual(values = colores_status)
```


```{r}
#| echo: false
sentinel_export <- 
  sentinel_date |>  
  filter(iv %in% c("evi", "ndvi", "nbr")) |> 
  filter(!(iv == "ndvi" & date2 == "2018-05-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  filter(!(iv == "evi" & date2 == "2018-05-01" & sp == "Pinus sylvestris" & status == "Decaimiento")) |> 
  filter(!(iv == "evi" & date2 == "2019-11-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  filter(!(iv == "nbr" & date2 == "2018-05-01" & sp == "Pinus sylvestris" & status == "Sanos")) |> 
  dplyr::select(-n) 


landsat_export <- bind_rows(
  (landsat_ndvi_yearly |> mutate(iv = "ndvi")), 
  (landsat_evi_yearly |> mutate(iv = "evi"))) |> 
  dplyr::select(-n)
  
write_csv(sentinel_export, "output/sentinel_serie.csv")
write_csv(landsat_export, "output/landsat_serie.csv")
```

## Temporal trends of EVI 


